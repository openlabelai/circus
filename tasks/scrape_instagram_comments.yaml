name: scrape_instagram_comments
description: Open Instagram, navigate to an artist's profile, and extract comments from recent posts
target_package: com.instagram.android
timeout: 600.0
retry_count: 0
actions:
# Force-restart Instagram so we start clean
- action: app_stop
  package: com.instagram.android
- action: random_sleep
  min: 1
  max: 2
- action: app_start
  package: com.instagram.android
- action: random_sleep
  min: 4
  max: 6

# Dismiss any login/notification popups
- action: if
  condition:
    element_exists:
      text: Not Now
  then:
  - action: tap
    text: Not Now
  - action: random_sleep
    min: 1
    max: 2

# Check for action-blocked dialog before proceeding
- action: if
  condition:
    element_exists:
      resourceId: com.instagram.android:id/block_popup
  then:
  - action: tap
    resource_id: com.instagram.android:id/primary_button
    timeout: 5
  - action: random_sleep
    min: 2
    max: 4

# Open exact profile via Instagram deep-link; fallback to strict search flow
- action: try
  actions:
  - action: open_url
    url: "instagram://user?username={task.instagram_handle}"
    package: com.instagram.android
  - action: random_sleep
    min: 2
    max: 3
  - action: assert
    condition:
      screen_is: instagram_profile
    timeout: 8
    message: "Deep-link did not open a profile screen"
  - action: assert
    condition:
      element_exists:
        resourceId: com.instagram.android:id/action_bar_title
        text: "{task.instagram_handle}"
    timeout: 8
    message: "Deep-link opened wrong profile"
  on_error:
  # Fallback: navigate via Search tab using GramAddict-style flow
  - action: tap
    description: Search and explore
    timeout: 10
  - action: random_sleep
    min: 2
    max: 3
  - action: tap
    text: Search
    timeout: 5
  - action: random_sleep
    min: 1
    max: 2
  - action: try
    actions:
    - action: clear
      resource_id: com.instagram.android:id/action_bar_search_edit_text
    on_error: []
  - action: type
    into_by: resourceId
    into: com.instagram.android:id/action_bar_search_edit_text
    text: "{task.instagram_handle}"
  - action: random_sleep
    min: 2
    max: 3
  # Switch to Accounts tab if visible (GramAddict pattern)
  - action: if
    condition:
      element_exists:
        text: Accounts
    then:
    - action: tap
      text: Accounts
    - action: random_sleep
      min: 1
      max: 2
  # Try tapping search result by username resource ID first
  - action: try
    actions:
    - action: tap
      resource_id: com.instagram.android:id/row_search_user_username
      index: 0
      timeout: 8
    on_error:
    - action: tap
      text: "{task.instagram_handle}"
      index: 1
      timeout: 10
  - action: random_sleep
    min: 1.5
    max: 2.5
  - action: try
    actions:
    - action: assert
      condition:
        screen_is: instagram_profile
      timeout: 8
      message: "Fallback did not open a profile screen"
    - action: assert
      condition:
        element_exists:
          resourceId: com.instagram.android:id/action_bar_title
          text: "{task.instagram_handle}"
      timeout: 8
      message: "Fallback opened wrong profile"
    on_error:
    - action: try
      actions:
      - action: press
        key: back
      on_error: []
    - action: random_sleep
      min: 1
      max: 2
    - action: tap
      text: "{task.instagram_handle}"
      index: 2
      timeout: 10
    - action: random_sleep
      min: 1.5
      max: 2.5
    - action: assert
      condition:
        screen_is: instagram_profile
      timeout: 8
      message: "Fallback retry did not open a profile screen"
    - action: assert
      condition:
        element_exists:
          resourceId: com.instagram.android:id/action_bar_title
          text: "{task.instagram_handle}"
      timeout: 8
      message: "Fallback retry opened wrong profile"

# Check for private profile before attempting to scrape
- action: if
  condition:
    element_exists:
      resourceId: com.instagram.android:id/private_profile_empty_state
  then:
  - action: assert
    condition:
      element_not_exists:
        resourceId: com.instagram.android:id/private_profile_empty_state
    message: "Profile is private — cannot scrape comments"

# Tap first post from profile grid using stable resource IDs
- action: try
  actions:
  - action: tap
    resource_id: com.instagram.android:id/image_button
    index: 0
    timeout: 8
  on_error:
  - action: tap
    resource_id: com.instagram.android:id/media_container
    index: 0
    timeout: 8
- action: random_sleep
  min: 2
  max: 3
- action: try
  actions:
  - action: assert
    condition:
      screen_not: instagram_profile
    timeout: 6
    message: "Did not land in post view after first grid tap"
  on_error:
  - action: try
    actions:
    - action: press
      key: back
    on_error: []
  - action: random_sleep
    min: 1
    max: 2
  - action: try
    actions:
    - action: tap
      resource_id: com.instagram.android:id/image_button
      index: 0
      timeout: 8
    on_error:
    - action: tap
      resource_id: com.instagram.android:id/media_container
      index: 0
      timeout: 8
  - action: random_sleep
    min: 2
    max: 3
  - action: assert
    condition:
      screen_not: instagram_profile
    timeout: 8
    message: "Retry did not land in post view"

# For N posts: open comments, extract comments with scrolling, return to post, next post
- action: repeat
  count: "{task.post_count}"
  actions:
  # Open comment drawer — resource ID first, vision fallback for Reels
  - action: try
    actions:
    - action: tap
      resource_id: com.instagram.android:id/row_feed_button_comment
      timeout: 6
    on_error:
    - action: vision_tap
      prompt: |
        You are on an Instagram post or Reel screen.
        Tap the comment icon (speech bubble).
        On regular posts it is in the action bar below the image.
        On Reels it is on the right-side toolbar.
        Do not tap like, share, save, or profile elements.
  - action: random_sleep
    min: 2
    max: 3

  # Verify we're in the comments screen
  - action: try
    actions:
    - action: wait
      resource_id: com.instagram.android:id/layout_comment_thread_edittext
      timeout: 6
    on_error: []

  # Batch 1: extract visible comments via vision
  - action: vision
    prompt: |
      Extract up to 10 fan comment texts from this Instagram comments screen.
      Return STRICT JSON only: {"comments": ["c1","c2",...]}
      Rules:
      - Maximum 10 comments
      - Only the comment body text (no usernames, timestamps, like counts, "Reply", "See translation")
      - Remove duplicates
      - If fewer than 10 are visible, return as many as visible
      - If this is not a comments screen, return {"comments": []}

  # Scroll comments drawer for more comments
  - action: random_sleep
    min: 1
    max: 2
  - action: swipe
    direction: up
  - action: random_sleep
    min: 1.5
    max: 2.5

  # Batch 2: extract after first scroll
  - action: vision
    prompt: |
      Extract up to 10 fan comment texts from this Instagram comments screen.
      Return STRICT JSON only: {"comments": ["c1","c2",...]}
      Rules:
      - Maximum 10 comments
      - Only the comment body text (no usernames, timestamps, like counts, "Reply", "See translation")
      - Remove duplicates
      - If fewer than 10 are visible, return as many as visible
      - If this is not a comments screen, return {"comments": []}

  # Scroll again for batch 3
  - action: random_sleep
    min: 1
    max: 2
  - action: swipe
    direction: up
  - action: random_sleep
    min: 1.5
    max: 2.5

  # Batch 3: extract after second scroll
  - action: vision
    prompt: |
      Extract up to 10 fan comment texts from this Instagram comments screen.
      Return STRICT JSON only: {"comments": ["c1","c2",...]}
      Rules:
      - Maximum 10 comments
      - Only the comment body text (no usernames, timestamps, like counts, "Reply", "See translation")
      - Remove duplicates
      - If fewer than 10 are visible, return as many as visible
      - If this is not a comments screen, return {"comments": []}

  - action: random_sleep
    min: 1
    max: 2

  # Return to post
  - action: press
    key: back
  - action: random_sleep
    min: 1
    max: 2

  # Check for action-blocked popup between posts
  - action: if
    condition:
      element_exists:
        resourceId: com.instagram.android:id/block_popup
    then:
    - action: tap
      resource_id: com.instagram.android:id/primary_button
      timeout: 5
    - action: random_sleep
      min: 3
      max: 5

  # Move to next post
  - action: swipe
    direction: up
  - action: random_sleep
    min: 2
    max: 3
