name: scrape_instagram_comments
description: Open Instagram, navigate to an artist's profile, and extract comments from recent posts
target_package: com.instagram.android
timeout: 600.0
retry_count: 0
actions:
# Force-restart Instagram so deep link navigates cleanly
- action: app_stop
  package: com.instagram.android
- action: random_sleep
  min: 1
  max: 2
# Navigate directly to the profile via deep link — avoids search entirely
- action: open_url
  url: "https://www.instagram.com/{task.instagram_handle}/"
- action: random_sleep
  min: 5
  max: 7

# Dismiss any popups
- action: if
  condition:
    element_exists:
      text: Not Now
  then:
  - action: tap
    text: Not Now
  - action: random_sleep
    min: 1
    max: 2

# Verify we landed on a profile page — wait for post count header
- action: try
  actions:
  - action: wait
    resource_id: com.instagram.android:id/row_profile_header_textview_post_count
    timeout: 10
  on_error:
  - action: random_sleep
    min: 3
    max: 5

# Tap first post in grid using vision (coordinate-based)
- action: vision_tap
  prompt: |
    I see an Instagram profile page. Below the bio/stats section there is a grid of photo/video posts arranged in 3 columns.
    I need to tap the FIRST post (top-left thumbnail in the grid).
    Return the coordinates of the center of that first thumbnail image.
- action: random_sleep
  min: 2
  max: 3

# For N posts: open comments, extract, scroll to next post
- action: repeat
  count: "{task.post_count}"
  actions:
  - action: try
    actions:
    # Tap the comment button to open full comment view
    - action: tap
      resource_id: com.instagram.android:id/row_feed_button_comment
      timeout: 5
    - action: random_sleep
      min: 2
      max: 3
    # Extract comments from the comment thread via UI hierarchy
    - action: extract_elements
      resource_id: com.instagram.android:id/row_comment_textview_comment
      key: comments
    - action: random_sleep
      min: 1
      max: 2
    # Scroll down for more comments
    - action: swipe
      direction: up
    - action: random_sleep
      min: 1
      max: 2
    # Extract more comments after scrolling
    - action: extract_elements
      resource_id: com.instagram.android:id/row_comment_textview_comment
      key: comments
    - action: random_sleep
      min: 1
      max: 2
    # Scroll down once more
    - action: swipe
      direction: up
    - action: random_sleep
      min: 1
      max: 2
    # Extract third batch
    - action: extract_elements
      resource_id: com.instagram.android:id/row_comment_textview_comment
      key: comments
    # Go back to post view
    - action: press
      key: back
    - action: random_sleep
      min: 1
      max: 2
    on_error:
    # If comment button not found, try vision extraction as fallback
    - action: vision
      prompt: |
        Extract all visible Instagram comment text from this screen.
        Return JSON: {"comments": ["comment1", "comment2", ...]}
        Only the comment text — no usernames, timestamps, or like counts.
        If no comments are visible, return {"comments": []}
      extract: true
  # Swipe to next post in feed
  - action: swipe
    direction: up
  - action: random_sleep
    min: 2
    max: 3
