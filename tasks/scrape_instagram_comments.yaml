name: scrape_instagram_comments
description: Open Instagram, navigate to an artist's profile, and extract comments from recent posts
target_package: com.instagram.android
timeout: 600.0
retry_count: 0
actions:
# Force-restart Instagram so we start clean
- action: app_stop
  package: com.instagram.android
- action: random_sleep
  min: 1
  max: 2
- action: app_start
  package: com.instagram.android
- action: random_sleep
  min: 4
  max: 6

# Dismiss any login/notification popups
- action: if
  condition:
    element_exists:
      text: Not Now
  then:
  - action: tap
    text: Not Now
  - action: random_sleep
    min: 1
    max: 2

# Open exact profile via Instagram deep-link; fallback to strict search flow
- action: try
  actions:
  - action: open_url
    url: "instagram://user?username={task.instagram_handle}"
    package: com.instagram.android
  - action: random_sleep
    min: 2
    max: 3
  - action: assert
    condition:
      screen_is: instagram_profile
    timeout: 8
    message: "Deep-link did not open a profile screen"
  - action: assert
    condition:
      element_exists:
        resourceId: com.instagram.android:id/action_bar_title
        text: "{task.instagram_handle}"
    timeout: 8
    message: "Deep-link opened wrong profile"
  on_error:
  - action: tap
    description: Search and explore
    timeout: 10
  - action: random_sleep
    min: 2
    max: 3
  - action: tap
    text: Search
    timeout: 5
  - action: random_sleep
    min: 1
    max: 2
  - action: try
    actions:
    - action: clear
      resource_id: com.instagram.android:id/action_bar_search_edit_text
    on_error: []
  - action: type
    into_by: resourceId
    into: com.instagram.android:id/action_bar_search_edit_text
    text: "{task.instagram_handle}"
  - action: random_sleep
    min: 2
    max: 3
  - action: if
    condition:
      element_exists:
        text: Accounts
    then:
    - action: tap
      text: Accounts
    - action: random_sleep
      min: 1
      max: 2
  - action: tap
    text: "{task.instagram_handle}"
    index: 1
    timeout: 10
  - action: random_sleep
    min: 1.5
    max: 2.5
  - action: try
    actions:
    - action: assert
      condition:
        screen_is: instagram_profile
      timeout: 8
      message: "Fallback did not open a profile screen"
    - action: assert
      condition:
        element_exists:
          resourceId: com.instagram.android:id/action_bar_title
          text: "{task.instagram_handle}"
      timeout: 8
      message: "Fallback opened wrong profile"
    on_error:
    - action: try
      actions:
      - action: press
        key: back
      on_error: []
    - action: random_sleep
      min: 1
      max: 2
    - action: tap
      text: "{task.instagram_handle}"
      index: 2
      timeout: 10
    - action: random_sleep
      min: 1.5
      max: 2.5
    - action: assert
      condition:
        screen_is: instagram_profile
      timeout: 8
      message: "Fallback retry did not open a profile screen"
    - action: assert
      condition:
        element_exists:
          resourceId: com.instagram.android:id/action_bar_title
          text: "{task.instagram_handle}"
      timeout: 8
      message: "Fallback retry opened wrong profile"

# Tap first post from profile grid using stable resource IDs
- action: try
  actions:
  - action: tap
    resource_id: com.instagram.android:id/image_button
    index: 0
    timeout: 8
  on_error:
  - action: tap
    resource_id: com.instagram.android:id/grid_card_layout_container
    index: 0
    timeout: 8
- action: random_sleep
  min: 2
  max: 3
- action: try
  actions:
  - action: assert
    condition:
      screen_not: instagram_profile
    timeout: 6
    message: "Did not land in post view after first grid tap"
  on_error:
  - action: try
    actions:
    - action: press
      key: back
    on_error: []
  - action: random_sleep
    min: 1
    max: 2
  - action: try
    actions:
    - action: tap
      resource_id: com.instagram.android:id/image_button
      index: 0
      timeout: 8
    on_error:
    - action: tap
      resource_id: com.instagram.android:id/grid_card_layout_container
      index: 0
      timeout: 8
  - action: random_sleep
    min: 2
    max: 3
  - action: assert
    condition:
      screen_not: instagram_profile
    timeout: 8
    message: "Retry did not land in post view"

# For N posts: open comments, extract up to 10 comments, return to post, go to next post
- action: repeat
  count: "{task.post_count}"
  actions:
  # Open comment drawer
  - action: vision_tap
    prompt: |
      You are on an Instagram post screen.
      Tap the comment icon (speech bubble) on the right-side action rail.
      Do not tap like, share, save, or profile elements.
  - action: random_sleep
    min: 2
    max: 3

  # Collect up to 10 comments for this post
  - action: vision
    prompt: |
      Extract up to 10 comment texts from this Instagram comments screen.
      Return STRICT JSON only: {"comments": ["c1","c2",...]}
      Rules:
      - Maximum 10 comments
      - Only comment text (no usernames, timestamps, likes, translation labels)
      - Remove duplicates
      - If fewer than 10 are visible, return as many as visible
  - action: random_sleep
    min: 1
    max: 2

  # Return to post
  - action: press
    key: back
  - action: random_sleep
    min: 1
    max: 2

  # Move to next post in the profile post viewer
  - action: swipe
    direction: up
  - action: random_sleep
    min: 2
    max: 3
