name: harvest_instagram_commenters
description: Navigate to an artist's Instagram posts via search and extract commenter data using vision LLM
target_package: com.instagram.android
timeout: 600
retry_count: 0
actions:
  # Force-close Instagram to start from a clean state
  - action: app_stop
    package: com.instagram.android
  - action: sleep
    duration: 0.6

  # Launch Instagram fresh
  - action: app_start
    package: com.instagram.android
  - action: sleep
    duration: 3.0

  # Tap the Search/Explore tab (bottom nav bar)
  - action: tap
    resource_id: com.instagram.android:id/search_tab
    timeout: 10
  - action: sleep
    duration: 1.2

  # Tap the search input bar at the top
  - action: tap
    resource_id: com.instagram.android:id/action_bar_search_edit_text
    timeout: 5
  - action: sleep
    duration: 0.6

  # Type the artist handle
  - action: type
    into: com.instagram.android:id/action_bar_search_edit_text
    into_by: resourceId
    text: "{task.artist_name}"
  - action: sleep
    duration: 2.0

  # Tap the Accounts tab to filter search results
  - action: try
    actions:
      - action: tap
        text: "Accounts"
        timeout: 5
    on_error:
      - action: detect_screen
  - action: sleep
    duration: 1.2

  # Tap the exact matching search result
  - action: try
    actions:
      - action: tap
        resource_id: com.instagram.android:id/row_search_user_username
        text: "{task.artist_name}"
        timeout: 5
    on_error:
      - action: detect_screen
  - action: sleep
    duration: 2.5

  # Verify we're on the profile
  - action: detect_screen

  # Tap the first post in the grid
  - action: try
    actions:
      - action: tap
        resource_id: com.instagram.android:id/image_button
        timeout: 10
    on_error:
      - action: try
        actions:
          - action: tap
            resource_id: com.instagram.android:id/media_image_button
            timeout: 5
        on_error:
          - action: detect_screen
  - action: sleep
    duration: 1.2

  # Tap the comment button to open comments
  - action: try
    actions:
      - action: tap
        resource_id: com.instagram.android:id/row_feed_button_comment
        timeout: 5
    on_error:
      - action: try
        actions:
          - action: tap
            text: "View all"
            timeout: 5
        on_error:
          - action: detect_screen
  - action: sleep
    duration: 1.2

  # Scroll and extract commenters using vision LLM
  - action: repeat
    count: 8
    actions:
      - action: vision
        prompt: >
          Extract all visible comments from this Instagram comments section screenshot.
          Return a JSON object with a "profiles" array. Each entry should have:
          - "username": the commenter's Instagram handle
          - "comment_text": the full comment text
          - "comment_style": categorize the comment (e.g. "emoji_only", "short_reaction", "detailed_opinion", "question", "tag_friend", "lyrics_quote")
          - "has_replies": true if there are visible replies to this comment
          - "is_liked_by_author": true if the comment shows a heart/like from the post author
          Return ONLY valid JSON, no markdown.
        max_tokens: 1000

      - action: swipe
        direction: up
      - action: random_sleep
        min: 0.9
        max: 1.8
